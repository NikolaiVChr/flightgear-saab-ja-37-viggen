<?xml version="1.0"?>

<system name="flight">

    <channel execrate="4" name="Aerodynamic info">

        <fcs_function name="systems/flight/axial-force-lb">
            <function>
                <sum>
                    <property>aero/coefficient/CAtakeoff</property>
                    <property>aero/coefficient/CACanopy</property>
                    <property>aero/coefficient/CABrake</property>
                    <property>aero/coefficient/CATurbine</property>                    
                    <property>aero/coefficient/CACanopyOff</property>
                    <property>aero/coefficient/CAElevonLeft</property>
                    <property>aero/coefficient/CAElevonRight</property>
                    <property>aero/coefficient/CARudder</property>
                    <property>aero/coefficient/CAMissile1</property>
                    <property>aero/coefficient/CAMissile2</property>
                    <property>aero/coefficient/CAMissile3</property>
                    <property>aero/coefficient/CAMissile4</property>
                    <property>aero/coefficient/CAMissile5</property>
                    <property>aero/coefficient/CAMissile6</property>
                    <property>aero/coefficient/CAMissile7</property>
                    <property>aero/coefficient/CATank</property>
                    <property>aero/coefficient/CA</property>
                    <property>aero/coefficient/CAwave</property>
                    <property>aero/coefficient/CABrake</property>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/normal-force-lb">
            <function>
                <sum>
                    <property>aero/coefficient/CN</property>
                    <property>aero/coefficient/CNGnd</property>
                    <property>aero/coefficient/CNGndElevator</property>
                    <property>aero/coefficient/CNflaps</property>
                    <property>aero/coefficient/CNgear</property>
                    <property>aero/coefficient/CNwave</property>
                    <property>aero/coefficient/CNBrake</property>
                    <property>aero/coefficient/CNTurbine</property>
                    <property>aero/coefficient/CNCanopy</property>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-force-lb">
            <function>
                <difference>
                    <product>
                        <property>systems/flight/normal-force-lb</property>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
                    <product>
                        <property>systems/flight/axial-force-lb</property>
                        <sin>
                            <property>aero/alpha-rad</property>
                        </sin>
                    </product>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/drag-force-lb">
            <function>
                <sum>
                    <product>
                        <property>systems/flight/normal-force-lb</property>
                        <sin>
                            <property>aero/alpha-rad</property>
                        </sin>
                    </product>
                    <product>
                        <property>systems/flight/axial-force-lb</property>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/drag-force-tank-lb">
            <function>
                    <product>
                        <property>aero/coefficient/CATank</property>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/drag-force-N">
            <function>
                <product>
                    <property>systems/flight/drag-force-lb</property>
                    <value>4.44822</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/drag-force-clean-N">
            <function>
                <product>
                    <difference>
                        <property>systems/flight/drag-force-lb</property>
                        <property>systems/flight/drag-force-tank-lb</property>
                    </difference>
                    <value>4.44822</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/Cd-total">
            <function>
                <quotient>
                    <quotient>
                        <property>systems/flight/drag-force-lb</property>
                        <property>aero/qbar-psf</property>
                    </quotient>
                    <property>metrics/Sw-sqft</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/excess-thrust-lb">
            <function>
                <difference>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>systems/flight/drag-force-lb</property>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-drag-ratio">
            <function>
                <quotient>
                    <property>systems/flight/lift-force-lb</property>
                    <property>systems/flight/drag-force-lb</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/thrust-weight-ratio">
            <function>
                <quotient>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>inertia/weight-lbs</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-weight-ratio">
            <function>
                <quotient>
                    <property>systems/flight/lift-force-lb</property>
                    <property>inertia/weight-lbs</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/thrust-drag-ratio">
            <function>
                <quotient>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>systems/flight/drag-force-lb</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/turning-radius-nm">
            <function>
                <abs>
                    <quotient>
                        <product>
                            <product>
                                <property>velocities/vg-fps</property>
                                <value>0.000164578834</value>
                                <!-- convert fps to nm/sec -->
                            </product>
                            <quotient>
                                <product>
                                    <pi/>
                                    <value>2.0</value>
                                </product>
                                <property>velocities/psidot-rad_sec</property>
                            </quotient>
                        </product>
                        <product>
                            <pi/>
                            <value>0.5</value>
                        </product>
                    </quotient>
                </abs>
            </function>
        </fcs_function>

        <switch name="aero/spin-norm">
            <default value="0"/>
            <test logic="OR" value="1">
                velocities/r-aero-rad_sec gt  0.724
                velocities/r-aero-rad_sec lt -0.724
            </test>
        </switch>
        
    </channel>

    <channel execrate="4" name="autopilot">

        <kinematic name="autopilot/throttle-lever-pos">
            <input>autopilot/throttle-lever-cmd</input>
            <traverse>
                <setting>
                    <position>0.0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>1.0</position>
                    <time>0.35</time>
                </setting>
            </traverse>
        </kinematic>

        <switch name="autopilot/gears-time-steady">
            <default value="sim-time-sec"/>
            <test logic="OR" value="autopilot/gears-time-steady">
                gear/gear-pos-norm == 1
            </test>
        </switch>

        <fcs_function name="autopilot/gears-time-AoA-hold">
            <function>
                <sum>
                    <p>autopilot/gears-time-steady</p>
                    <v>5</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="autopilot/AoA-hold">
            <default value="0"/>
            <test logic="OR" value="1">
                sim-time-sec gt autopilot/gears-time-AoA-hold
            </test>
        </switch>

        <fcs_function name="autopilot/max-roll">
            <function>
                <table>
                    <independentVar lookup="row">velocities/vtrue-kts</independentVar>
                    <tableData>
                        124 20
                        351 60
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="autopilot/min-roll">
            <function>
                <table>
                    <independentVar lookup="row">velocities/vtrue-kts</independentVar>
                    <tableData>
                        124 -20
                        351 -60
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="autopilot/roll-hold">
            <default value="/autopilot/internal/target-roll-deg"/>
            <test logic="OR" value="autopilot/max-roll">
                /autopilot/internal/target-roll-deg gt autopilot/max-roll
            </test>
            <test logic="OR" value="autopilot/min-roll">
                /autopilot/internal/target-roll-deg lt autopilot/min-roll
            </test>
            <output>/autopilot/internal/target-roll-deg</output>
        </switch>

        <fcs_function name="autopilot/min-g">
            <function>
                <table>
                    <independentVar lookup="row">/orientation/roll-deg</independentVar>
                    <tableData>
                        -60 -2
                          0 -0.75
                         60 -2
                    </tableData>
                </table>
            </function>
        </fcs_function>

    </channel>

    <channel execrate="4" name="effects">

        <fcs_function name="effects/wingtip-vapour">
            <function>
                <and>
                   <gt>
                     <property>/velocities/airspeed-kt</property>
                     <value>120</value>
                   </gt>
                   <gt>
                     <property>/environment/relative-humidity</property>
                     <value>50</value>
                   </gt>
                   <or>
                     <lt>
                       <property>/position/altitude-ft</property>
                       <value>800</value>
                     </lt>
                      <gt>
                        <property>aero/alpha-deg</property>
                        <value>11.0</value>
                      </gt>
                   </or>
                   <lt>
                     <property>/environment/temperature-degc</property>
                     <value>20</value>
                   </lt>
                   <property>structural/wings/serviceable</property>
                 </and>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/buffeting/output">
            <function>
                <product>
                    <sum>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var1</property>
                          </product>
                        </sin>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var2</property>
                          </product>
                        </sin>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var3</property>
                          </product>
                        </sin>
                    </sum>
                    <!--<table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                              0.0         1.0
                          30000.0         0.0
                        </tableData>
                    </table>-->
                    <property>systems/flight/buffeting/magnitude</property>
                </product>
            </function>
        </fcs_function>        

    </channel>

    <channel execrate="4" name="payloads">

        <pure_gain name="names/payload/pilot-lbm">
            <input>/payload/weight[7]/weight-lb</input>
            <gain>1</gain>
            <output>inertia/pointmass-weight-lbs[0]</output>
        </pure_gain>

    </channel>

    <channel execrate="1" name="rdr-heading-compass">
            <!-- as per manual: radar compass max rotate with 30 deg/s
                                radar compass bug max rotate with 25 deg/s -->

            <!-- RJH:2017-04: 
            work out heading demand (from 0 to 360) wrapping values around the zero point
                from 0 to 359: delta -1
                from 1 to 2: delta 1
                from 2 to 1: delta -1
                from 359 to 0: delta 1
                
                in traditional language: 
                double GetROC(double current, double demand)
                {

                    if (Math.Abs(current-demand) > 180)
                        if (current > demand)
                            return (demand+180) - (current-180);
                        else
                            return (demand-180) - (current+180);

                    return demand-current;
                }
        -->
        <fcs_function name="systems/demand-bug">
            <function>
                <ifthen>
                    <ge>
                        <abs>
                            <difference>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel</property>
                            </difference>
                        </abs>
                        <value>180</value>
                    </ge>
                    <ifthen>
                        <ge>
                            <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                            <property>/autopilot/route-manager/wp/bearing-deg-rel</property>
                        </ge>
                        <difference>
                            <sum>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel</property>
                                <value>180</value>
                            </sum>
                            <difference>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                                <value>180</value>
                            </difference>
                        </difference>
                        <difference>
                            <difference>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel</property>
                                <value>180</value>
                            </difference>
                            <sum>
                                <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                                <value>180</value>
                            </sum>
                        </difference>
                    </ifthen>
                    <difference>
                        <property>/autopilot/route-manager/wp/bearing-deg-rel</property>
                        <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                    </difference>                        
                </ifthen>
            </function>
        </fcs_function>

        <fcs_function name="systems/demand-bug-rate">
            <function>
                <sum>
                    <max>
                        <product>
                            <property>simulation/dt</property>
                            <value>-25</value>
                        </product>
                        <min>
                            <product>
                                <property>simulation/dt</property>
                                <value>25</value>
                            </product>
                            <property>systems/demand-bug</property>
                        </min>
                    </max>
                    <property>/autopilot/route-manager/wp/bearing-deg-rel-rate</property>
                </sum>
            </function>
            <output>/autopilot/route-manager/wp/bearing-deg-rel-rate</output>
        </fcs_function>

        <fcs_function name="systems/demand-heading">
            <function>
                <ifthen>
                    <ge>
                        <abs>
                            <difference>
                                <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                                <property>/orientation/heading-magnetic-deg</property>
                            </difference>
                        </abs>
                        <value>180</value>
                    </ge>
                    <ifthen>
                        <ge>
                            <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                            <property>/orientation/heading-magnetic-deg</property>
                        </ge>
                        <difference>
                            <sum>
                                <property>/orientation/heading-magnetic-deg</property>
                                <value>180</value>
                            </sum>
                            <difference>
                                <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                                <value>180</value>
                            </difference>
                        </difference>
                        <difference>
                            <difference>
                                <property>/orientation/heading-magnetic-deg</property>
                                <value>180</value>
                            </difference>
                            <sum>
                                <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                                <value>180</value>
                            </sum>
                        </difference>
                    </ifthen>
                    <difference>
                        <property>/orientation/heading-magnetic-deg</property>
                        <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                    </difference>
                        
                </ifthen>
            </function>
        </fcs_function>

        <fcs_function name="systems/demand-heading-rate">
            <function>
                <sum>
                    <max>
                        <product>
                            <property>simulation/dt</property>
                            <value>-30</value>
                        </product>
                        <min>
                            <product>
                                <property>simulation/dt</property>
                                <value>30</value>
                            </product>
                            <property>systems/demand-heading</property>
                        </min>
                    </max>
                    <property>/ja37/avionics/heading-magnetic-limited-deg</property>
                </sum>
            </function>
            <output>/ja37/avionics/heading-magnetic-limited-deg</output>
        </fcs_function>

    </channel>

    <channel execrate="4" name="investigate-intake-flow">

        <!--<fcs_function name="propulsion/engine/intake-flow-number-factor">
            <description>
                         mil*factor
                CA = ____________________________
                     rho*intakeArea*freeflowspeed

                     For mach 0.4 (AJ37):
                CA = 1.3
                intakeArea = 0.6 m^2 / 6.46 ft^2
                freeflowspeed = velocities/uBody-fps
                rho = atmosphere/rho-slugs_ft3
                mil = propulsion/engine/MilThrust

                          CA*rho*area*speed
                factor = __________________
                                mil


                Test:
                  fly 0.4M
                  full mil thrust
                  0m alt
                  ISA conditions
                  factor = 0.0001395
            </description>
            <function>
                <quotient>
                    <product>
                        <value>1.3</value>
                        <value>6.46</value>
                        <property>atmosphere/rho-slugs_ft3</property>
                        <property>/velocities/uBody-fps</property>
                    </product>
                    <property>propulsion/engine/mil-rate</property>
                </quotient>
            </function>
        </fcs_function>-->

    </channel>











    <channel execrate="4" name="instruments">
        <fcs_function name="names/instruments/indicated-altitude-meter">
            <function>
                <product>
                    <p>/instrumentation/altimeter/indicated-altitude-ft</p>
                    <v>0.3048</v>
                </product>
            </function>
            <output>/instrumentation/altimeter/indicated-altitude-meter</output>
        </fcs_function>

        <switch name="systems/ins/time-steady">
            <default value="sim-time-sec"/>
            <test logic="AND" value="sim-time-sec">
                /ja37/avionics/button-snabbresn == 1
            </test>
            <test logic="AND" value="systems/ins/time-steady">
                /ja37/elec/ac-bus-main-bool == 1
                /ja37/elec/dc-bus-main-bool == 1
                /ja37/avionics/ins-cmd == 1
            </test>
            <test logic="AND" value="-1000">
                /ja37/avionics/init-done == 1
                sim-time-sec lt 300
            </test>
        </switch>

        <fcs_function name="systems/ins/time-init">
            <function>
                <sum>
                    <p>systems/ins/time-steady</p>
                    <v>140</v>
                </sum>
            </function>
        </fcs_function>
        
        <switch name="systems/ins/init">
            <default value="0"/>
            <test logic="AND" value="1">
                /ja37/elec/dc-bus-main-bool == 1
                sim-time-sec le systems/ins/time-init
                /ja37/avionics/ins-cmd == 1
            </test>
            <output>/ja37/avionics/ins-init</output>
        </switch>

        <switch name="systems/ins/running">
            <default value="0"/>
            <test logic="AND" value="1">
                /ja37/elec/dc-bus-main-bool == 1
                /ja37/avionics/ins-init == 0
                /ja37/avionics/ins-cmd == 1
                sim-time-sec gt systems/ins/time-init
            </test>
            <output>/ja37/avionics/ins</output>
        </switch>

        <switch name="systems/gps/time-steady">
            <default value="sim-time-sec"/>
            <test logic="AND" value="systems/gps/time-steady">
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
        </switch>

        <fcs_function name="systems/gps/time-bit">
            <function>
                <sum>
                    <p>systems/gps/time-steady</p>
                    <v>10</v>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/gps/time-init">
            <function>
                <sum>
                    <p>systems/gps/time-steady</p>
                    <v>40</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/gps/bit">
            <default value="0"/>
            <test logic="AND" value="1">
                sim-time-sec lt systems/gps/time-bit
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
            <output>/ja37/avionics/gps-bit</output>
        </switch>

        <switch name="systems/gps/init">
            <default value="0"/>
            <test logic="AND" value="1">
                sim-time-sec lt systems/gps/time-init
                systems/gps/bit == 0
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
            <output>/ja37/avionics/gps-init</output>
        </switch>

        <switch name="systems/gps/nav">
            <default value="0"/>
            <test logic="OR" value="1">
                sim-time-sec gt systems/gps/time-init
            </test>
            <output>/ja37/avionics/gps-nav</output>
        </switch>

        <!-- used for animating epr gauge -->
        <fcs_function name="propulsion/engine/mil-rate">
            <function>
                <!-- looked in JSBSim source code to find this formula for milthrust,
                     for the AJ I use also JA max mil value as its only a factor -->
                <product>
                    <table>
                        <independentVar lookup="row">propulsion/engine/n2</independentVar>
                        <tableData>
                             56.9 0
                             57   1
                        </tableData>
                    </table>
                    <sum>
                        <product>
                            <p>propulsion/engine/IdleThrust</p>
                            <v>72100</v>
                        </product>
                        <product>
                            <product>
                                <difference>
                                    <v>72100</v>
                                    <product>
                                        <p>propulsion/engine/IdleThrust</p>
                                        <v>72100</v>
                                    </product>
                                </difference>
                                <p>propulsion/engine/MilThrust</p>
                            </product>
                            <quotient>
                                <difference>
                                    <p>propulsion/engine/n2</p>
                                    <v>57</v>
                                </difference>
                                <v>43</v>
                            </quotient>
                            <quotient>
                                <difference>
                                    <p>propulsion/engine/n2</p>
                                    <v>57</v>
                                </difference>
                                <v>43</v>
                            </quotient>
                        </product>
                    </sum>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/p7-p2">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/mil-rate</independentVar>
                    <tableData>
                         1650     1.00 <!-- extrapolated -->
                         3000     1.02
                        72100     2.06 <!-- AJS-37 manual part 1, engine section -->
                       115000    2.705 <!-- extrapolated -->
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="names/instr/epr-direct">
            <default value="propulsion/engine/p7-p2"/>
            <test logic="OR" value="0">
              /ja37/elec/ac-bus-main-bool == 0
            </test>
            <output>/engines/engine/epr-direct</output>
        </switch>

        <lag_filter name="names/instr/epr">
            <input> /engines/engine/epr-direct </input>
            <c1> 5 </c1>
            <output>/engines/engine/epr-gauge</output>
        </lag_filter>

        <switch name="names/instr/fuel-on">
            <default value="/instrumentation/fuel/needleF_rot"/>
            <test logic="OR" value="/instrumentation/fuel/needleF_rot_on">
              /ja37/elec/ac-bus-main-bool == 0
            </test>
            <test logic="OR" value="0">
              /ja37/elec/dc-bus-main-bool == 0
            </test>
            <output>/instrumentation/fuel/needleF_rot_on</output>
        </switch>

        <lag_filter name="names/instr/fuel">
            <input> /instrumentation/fuel/needleF_rot_on </input>
            <c1> 5 </c1>
            <output>/instrumentation/fuel/needleF_rot_final</output>
        </lag_filter>

        <!-- used for animating nozzle indicator -->

        <fcs_function name="names/throttle/nozzle-zone">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/zone-scaled</independentVar>
                    <tableData>
                        0.00       0.15
                        0.25       0.38
                        0.50       0.60
                        1.00       1.00
                    </tableData>
                </table>
            </function>
            <output>propulsion/engine/zone-instr</output>
        </fcs_function>

        <switch name="names/throttle/nozzle-direct">
            <default value="propulsion/engine/zone-instr"/>
            <test logic="OR" value="0">
              /ja37/elec/dc-bus-main-bool == 0
            </test>
            <test logic="OR" value="/engines/engine/nozzle-pos-norm">
              propulsion/engine/zone == 0
              propulsion/engine/augmentation == 0
            </test>
            <output>propulsion/engine/nozzle-direct</output>
        </switch>

        <lag_filter name="names/throttle/nozzle">
            <input> propulsion/engine/nozzle-direct </input>
            <c1> 5 </c1>
            <output>propulsion/engine/nozzle</output>
        </lag_filter>

        <!-- used for animating tachometer -->
        <switch name="names/instr/tachometer-direct">
            <default value="propulsion/engine/n2"/>
            <test logic="OR" value="0">
              /ja37/elec/dc-bus-main-bool == 0
            </test>
            <output>propulsion/engine/tachometer-direct</output>
        </switch>

        <lag_filter name="names/instr/tachometer">
            <input> propulsion/engine/tachometer-direct </input>
            <c1> 5 </c1>
            <output>propulsion/engine/tachometer</output>
        </lag_filter>

        <fcs_function name="propulsion/engine/n2-mod">
            <function>
                <product>
                    <fraction>
                        <quotient>
                            <p>propulsion/engine/tachometer</p>
                            <v>10</v>
                        </quotient>
                    </fraction>
                    <v>10</v>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="names/instruments/g-force">
            <function>
                <quotient>
                    <p>accelerations/a-pilot-z-ft_sec2</p>
                    <v>-32.174</v>
                </quotient>
            </function>
            <output>/ja37/accelerations/pilot-G</output>
        </fcs_function>

        <!-- used for animating accelerometer -->
        <lag_filter name="names/instr/accelerometer">
            <input> /ja37/accelerations/pilot-G </input>
            <c1> 5 </c1>
            <output>/ja37/accelerations/pilot-G-lag</output>
        </lag_filter>

        <fcs_function name="names/instruments/g-force-norm">
            <function>
                    <product>
                        <p>/ja37/accelerations/pilot-G</p>
                        <v>0.01</v>
                    </product>
            </function>
            <output>/ja37/accelerations/pilot-G-norm</output>
        </fcs_function>
        
        <switch name="names/sound/max-pos-g">
            <default value="/ja37/sound/loadfactor-percent"/>
            <test logic="OR" value="110">
              /instrumentation/terrain-override == 1
            </test>
            <output>/ja37/sound/loadfactor-percent-used</output>
        </switch>
        
        <fcs_function name="names/instruments/max-positive-g-set">
            <function>
                    <product>
                        <v>0.01</v>                        
                        <p>/ja37/sound/loadfactor-percent-used</p>
                        <p>/limits/max-positive-g</p>
                    </product>
            </function>
            <output>/limits/max-positive-g-set</output>
        </fcs_function>
        
        <fcs_function name="names/instruments/sound-g-force-norm">
            <function>
                    <quotient>
                        <p>/ja37/accelerations/pilot-G-lag</p>
                        <p>/limits/max-positive-g-set</p>
                    </quotient>
            </function>
            <output>/ja37/sound/pilot-G-norm</output>
        </fcs_function>

        <!--<washout_filter name="names/instruments/g-force-damped">
          <input> /ja37/accelerations/pilot-G </input>
          <c1> 1 </c1>
          <output> /ja37/accelerations/pilot-G-damped </output>
        </washout_filter>-->

        <kinematic name="names/instruments/g-force-norm-damped">
            <input>/ja37/accelerations/pilot-G-norm</input>
            <traverse>
                <setting>
                    <position>-1</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>10</time>
                </setting>
            </traverse>
            <clipto>
                <min>-1</min>
                <max>1</max>
            </clipto>
            <output> /ja37/accelerations/pilot-G-norm-damped </output>
        </kinematic>

        <fcs_function name="names/instruments/g-force-damped">
            <function>
                    <product>
                        <p>/ja37/accelerations/pilot-G-norm-damped</p>
                        <v>100</v>
                    </product>
            </function>
            <output>/ja37/accelerations/pilot-G-damped</output>
        </fcs_function>
        
        <fcs_function name="systems/sound/alpha-limit-low-ja">
            <description>When 3hz tone comes</description>
            <function>
                <table>
                    <independentVar lookup="row">/position/altitude-ft</independentVar>
                    <tableData>
                        32808  17.00 
                        41010  14.00
                    </tableData>
                </table>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/sound/alpha-limit-low-aj">
            <description>When 3hz tone comes, guesses</description>
            <function>
                <table>
                    <independentVar lookup="row">/position/altitude-ft</independentVar>
                    <tableData>
                        32808  14.00
                        41010  11.00
                    </tableData>
                </table>
            </function>
        </fcs_function>
        
        <switch name="systems/sound/alpha-limit-low">
            <default value="systems/sound/alpha-limit-low-ja"/>
            <test logic="AND" value="systems/sound/alpha-limit-low-aj">
                /ja37/systems/variant gt 0
            </test>
        </switch>
        
        <fcs_function name="systems/sound/alpha-limit-medium">
            <function>
                    <sum>
                        <p>systems/sound/alpha-limit-low</p>
                        <v>3</v>
                    </sum>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/sound/alpha-limit-high">
            <function>
                    <sum>
                        <p>systems/sound/alpha-limit-low</p>
                        <v>6</v>
                    </sum>
            </function>
        </fcs_function>


        <!-- The ratio between N2 and N1 is approx 1:0.7184 -->

        <fcs_function name="propulsion/engine/aj37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0        0.00
                       59.0      120.83
                       74.0      151.33
                       93.3      190.83
                       96.5      197.50
                       97.3      199.17
                      100.0      204.63
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/ja37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0         0
                       57.0       118
                       70.5       149
                       88.5       181
                       93.9       192
                       94.8       194
                      100.0       204.6
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine/n2-rpm_r-s">
            <default value="0"/>
            <test logic="OR" value="propulsion/engine/ja37-n2-rpm_r-s">
                /ja37/systems/variant == 0
            </test>
            <test logic="OR" value="propulsion/engine/aj37-n2-rpm_r-s">
                /ja37/systems/variant gt 0
            </test>
        </switch>

        <fcs_function name="propulsion/engine/n2-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n2-rpm_r-s</property>
                    <value>60</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n1</property>
                    <value>88</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-s">
            <function>
                <quotient>
                    <property>propulsion/engine/n1-rpm_r-min</property>
                    <value>60</value>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/outlet-temperature-degc">
            <function>
                <quotient>
                    <difference>
                        <property>/engines/engine/egt-degf</property>
                        <value>32</value>
                    </difference>
                    <value>1.8</value>
                </quotient>
                <!--          <sum>
            <table>
              <independentVar lookup="row">propulsion/engine/thrust-lbs</independentVar>
              <tableData>
                  0.0         0
              35000.0       675
              </tableData>
            </table>
            <property>/environment/temperature-degc</property>
          </sum>-->
            </function>
        </fcs_function>

        <!-- page 137 of manual: mask oxygen supply -->
        <fcs_function name="systems/flight/oxygen-pressure-kPa">
            <function>
                <product>
                    <property>/controls/oxygen</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.1
                              59055.1         0.4 <!--  9000m cabin density alt / 18000m density alt -->
                              85301.8         6.7 <!-- 15000m cabin density alt / 26000m density alt -->
                        </tableData>
                    </table>
                    <table>
                        <independentVar lookup="row">/ja37/systems/oxygen-bottle-pressure</independentVar>
                        <tableData>
                            <!-- kp/cm2 -->
                                 15.0         0.0
                                 40.0         1.0
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/instr/oxygen-manometer-pre">
            <function>
                <product>
                    <property>/ja37/systems/oxygen-bottle-pressure</property>
                    <table>
                        <independentVar lookup="row">/ja37/elec/ac-bus-main-volt</independentVar>
                        <tableData>
                                 99.0         0.0
                                100.0         1.0
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <lag_filter name="systems/flight/instr/oxygen-manometer">
            <input> systems/flight/instr/oxygen-manometer-pre </input>
            <c1> 5 </c1>
            <output> /ja37/systems/oxygen-manometer </output>
        </lag_filter>

        <fcs_function name="systems/flight/environment-pressure-kPa">
            <function>
                <product>
                    <property>atmosphere/P-psf</property>
                    <value>0.047880258888979</value>
                </product>
            </function>
        </fcs_function>

        <!-- page 135 of manual -->
        <fcs_function name="systems/flight/closed-canopy-cabin-pressure-kPa">
            <function>
                <sum>
                    <property>systems/flight/environment-pressure-kPa</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.0
                               8500.0         0.0
                              16404.2        19.6 <!--  5000m density alt -->
                              65616.8        23.5 <!-- 20000m density alt -->
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/flight/cabin-pressure-tmp-kPa">
            <default value="systems/flight/closed-canopy-cabin-pressure-kPa"/>
            <test logic="OR" value="systems/flight/environment-pressure-kPa">
              fcs/canopy/pos-norm ne 0
              fcs/canopy/hinges/serviceable ne 1
            </test>
            <test logic="AND" value="systems/flight/cabin-pressure-tmp-kPa">
              gear/gear-pos-norm == 1
              gear/unit[0]/WOW ne 1
            </test>
        </switch>

        <lag_filter name="systems/flight/cabin-pressure-kPa">
            <input> systems/flight/cabin-pressure-tmp-kPa </input>
            <c1> 0.5 </c1>
        </lag_filter>

        <fcs_function name="systems/flight/cabin-pressure-kpm2">
            <!-- kilopond per square cm2-->
            <function>
                <product>
                    <property>systems/flight/cabin-pressure-kPa</property>
                    <value>0.010197162129779</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/cabin-diff-pressure-kpm2">
            <!-- kilopond per square cm2-->
            <function>
                <difference>
                    <property>systems/flight/cabin-pressure-kpm2</property>
                    <product>
                        <property>systems/flight/environment-pressure-kPa</property>
                        <value>0.010197162129779</value>
                    </product>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/brake-pressure-tmp-kpm2">
            <function>
                <product>
                    <or>
                        <property>/controls/gear/brake-left</property>
                        <property>/controls/gear/brake-parking</property>
                    </or>
                    <property>gear/unit[1]/WOW</property>
                    <table>
                        <independentVar lookup="row">forces/fbx-gear-lbs</independentVar>
                        <tableData>
                            -40000         400
                            -30000         300
                                 0         0.0
                             30000         300
                             40000         400
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <lag_filter name="systems/flight/brake-pressure-kpm2">
            <input> systems/flight/brake-pressure-tmp-kpm2 </input>
            <c1> 10 </c1>
        </lag_filter>

        <!-- animating AoA indicator -->
        <switch name="systems/flight/aoa-indicator-direct">
            <default value="aero/alpha-deg"/>
            <test logic="OR" value="0">
              /ja37/elec/dc-bus-main-bool == 0
            </test>
            <test logic="OR" value="/instrumentation/attitude-indicator/indicated-pitch-deg">
                gear/unit[0]/WOW == 1
            </test>
        </switch>

        <lag_filter name="systems/flight/aoa-indicator-locked">
            <input> systems/flight/aoa-indicator-direct </input>
            <c1> 5 </c1>
            <output> systems/flight/aoa-indicator </output>
        </lag_filter>

        <!-- AJS-37 manual part 2, page 173 -->
        <fcs_function name="systems/flight/rotation-speed">
            <function>
                <table>
                    <independentVar lookup="row">inertia/weight-lbs</independentVar>
                    <independentVar lookup="column">/environment/temperature-degc</independentVar>
                    <tableData>
                        <!-- rotation speed in Km/h at max afterburner -->
                                    -15.0    0.0   15.0   30.0
                        28660.09    122.5  133.0  150.0  167.5
                        33069.34    155.0  165.0  177.5  194.0
                        37478.58    180.0  190.0  202.5  216.0
                        41887.83    200.0  210.0  220.0  232.5
                        <!-- This output is at present not used as it gives about 75% of a sane value.
                             Not sure why. -->
                    </tableData>
                </table>
            </function>
        </fcs_function>

    </channel>

    <channel execrate="1" name="Engine">

        <!--
            tertiary engine opening, page 188 of JA37Di manual
        -->
        <switch name="systems/flight/tertiary/state-cmd">
            <default value="systems/flight/tertiary/state-cmd"/>
            <test logic="AND" value="0">
                <!-- gate closes -->
              systems/flight/tertiary/state-cmd == 1
              velocities/mach gt 0.67
              gear/gear-cmd-norm == 0
              propulsion/engine/zone gt 1
              /controls/engines/engine/cutoff-augmentation == 0
            </test>
            <test logic="AND" value="1">
                <!-- gate opens -->
              systems/flight/tertiary/state-cmd == 0
              velocities/mach lt 0.64              
            </test>
            <test logic="AND" value="1">
                <!-- gate opens -->
              systems/flight/tertiary/state-cmd == 0
              gear/gear-cmd-norm ne 0              
            </test>
            <test logic="AND" value="1">
                <!-- gate opens -->
              systems/flight/tertiary/state-cmd == 0
              propulsion/engine/zone le 1             
            </test>
            <test logic="AND" value="1">
                <!-- gate opens -->
              systems/flight/tertiary/state-cmd == 0
              /controls/engines/engine/cutoff-augmentation == 1             
            </test>
        </switch>

        <switch name="systems/flight/tertiary/state-current">
            <default value="systems/flight/tertiary/state"/>
            <test logic="AND" value="systems/flight/tertiary/state-cmd">
                /ja37/elec/dc-bus-main-bool == 1
            </test>
        </switch>

        <kinematic name="systems/flight/tertiary/state">
            <input>systems/flight/tertiary/state-current</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>5.0</time><!-- closing takes 5s as per manual -->
                </setting>
            </traverse>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
            <output> /ja37/systems/tertiary-opening </output>
        </kinematic>

        <!--
            Engine reversing, page 189 of JA37Di manual, page 220 of JA37C manual

            Todo: Blow off reverser doors if reversing is active while tertiary is closed or semi-closed.
        -->

        <switch name="systems/flight/reverse/R1-time">
            <default value="sim-time-sec"/>
            <test logic="OR" value="systems/flight/reverse/R1-time">
                gear/unit[2]/WOW == 1
            </test>
        </switch>

        <fcs_function name="systems/flight/reverse/R1-time-release">
            <function>
                <sum>
                    <p>systems/flight/reverse/R1-time</p>
                    <v>1</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/flight/reverse/R1">
            <default value="1"/>
            <test logic="OR" value="0">
                sim-time-sec gt systems/flight/reverse/R1-time-release
            </test>
        </switch>

        <switch name="systems/flight/reverse/R2-time">
            <default value="sim-time-sec"/>
            <test logic="OR" value="systems/flight/reverse/R2-time">
                gear/unit[0]/WOW == 0
            </test>
        </switch>

        <fcs_function name="systems/flight/reverse/R2-time-release">
            <function>
                <sum>
                    <p>systems/flight/reverse/R2-time</p>
                    <v>30</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/flight/reverse/R2">
            <default value="0"/>
            <test logic="AND" value="1">
                sim-time-sec lt systems/flight/reverse/R2-time-release
                systems/flight/reverse/R2-time lt sim-time-sec
            </test>
        </switch>

        <switch name="systems/flight/reverse/state-cmd">
            <default value="0"/>
            <test logic="AND" value="1">
              /ja37/systems/tertiary-opening == 1
              gear/gear-cmd-norm == 1
              gear/unit[0]/WOW == 1
              /controls/engines/engine[0]/reverser-cmd == 1
            </test>
            <test logic="AND" value="1">
              /controls/engines/engine[0]/reverser-cmd == 1
              /ja37/systems/tertiary-opening == 1
              gear/unit[2]/WOW == 1
              gear/gear-cmd-norm == 1
              systems/flight/reverse/R1 == 1
            </test>
            <test logic="AND" value="1">
              /controls/engines/engine[0]/reverser-cmd == 1
              /ja37/systems/tertiary-opening == 1
              gear/unit[2]/WOW == 1
              gear/gear-cmd-norm == 1
              systems/flight/reverse/R2 == 1
            </test>
        </switch>

        <switch name="systems/flight/reverse/state-current">
            <default value="systems/flight/reverse/state"/>
            <test logic="AND" value="systems/flight/reverse/state-cmd">
                /ja37/elec/dc-bus-main-bool == 1
                systems/hydraulics/system1/pressure == 1
                /controls/engines/engine[0]/reverse-system/serviceable == 1
            </test>
        </switch>

        <kinematic name="systems/flight/reverse/state">
            <input>systems/flight/reverse/state-current</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>1.5</time><!-- reversing takes 1.5s as per manual -->
                </setting>
            </traverse>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
            <output> /engines/engine[0]/reverser-pos-norm </output>
        </kinematic>
    
        <aerosurface_scale name="systems/flight/reverse/state-angle">
            <input>systems/flight/reverse/state</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> 0 </min>
                <max> 1 </max>
            </domain>
            <range>
                <min>0</min>                
                <max>2.0669551</max><!-- Max 7716.18lbs thrust. So acos(-34323.27876347009N / 72100N). -->
            </range>
            <output> propulsion/engine[0]/reverser-angle-rad </output>
        </aerosurface_scale>
        
        <switch name="systems/flight/reverse/is-reversed">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/flight/reverse/state == 1
            </test>
            <output> /engines/engine[0]/is-reversed </output>
        </switch>

        <fcs_function name="names/flight/reverser-position">
            <function>
                <difference>
                    <value>1</value>
                    <property>/engines/engine/reverser-pos-norm</property>
                </difference>
            </function>
            <output>/engines/engine/reverser-position</output>
        </fcs_function>

        <!-- absolute thrust (used for sound) -->
        <fcs_function name="systems/flight/engine/thrust_abs">
            <function>
                <abs>
                    <property>/engines/engine/thrust_lb</property>
                </abs>
            </function>
            <output>/engines/engine/thrust_lb-absolute</output>
        </fcs_function>

        <!-- for some reason this fails to write to the property, so is done in nasal.

        <switch name="systems/flight/engine/augmentation">
            <default value="0"/>
            <test logic="AND" value="1">
                propulsion/engine/augmentation == 1
            </test>
            <output> /controls/engines/engine/augmentation </output>
        </switch>

        <pure_gain name="systems/flight/engine/augmentation">
            <input>propulsion/engine/augmentation</input>
            <gain>1.0</gain>
            <output>/controls/engines/engine/augmentation</output>
        </pure_gain>-->


        <!-- inverted flight will make oil pressure drop -->

        <fcs_function name="systems/flight/oil/inverted-flight">
            <description>G of -1 will become +0.75, -0.25 will become +0</description>
            <function>
                <max>
                    <sum>
                        <product>
                            <property>accelerations/Nz</property>
                            <v>-1</v>
                        </product>
                        <v>-0.25</v>
                    </sum>
                    <v>0</v>
                </max>
            </function>
            <clipto>
                <min>0</min>
                <max>0.75</max>
            </clipto>
        </fcs_function>

        <kinematic name="systems/flight/oil/pressure-drop-norm">
            <input>systems/flight/oil/inverted-flight</input>
            <noscale/>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>0.75</position>
                    <time>15</time>
                </setting>
            </traverse>
        </kinematic>

        <fcs_function name="systems/flight/oil/pressure-drop-psi">
            <function>
                <product>
                    <property>/engines/engine/oil-pressure-psi</property>
                    <property>systems/flight/oil/pressure-drop-norm</property>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/oil-pressure-psi">
            <function>
                <max>
                    <value>0</value>
                    <difference>
                        <property>/engines/engine/oil-pressure-psi</property>
                        <property>systems/flight/oil/pressure-drop-psi</property>
                    </difference>
                </max>
            </function>
        </fcs_function>

        <switch name="propulsion/engine/cutoff-low-pressure">
            <default value="1"/>
            <test logic="AND" value="0">
                propulsion/engine/cutoff-commanded == 0
                systems/flight/oil/pressure-drop-norm lt 0.5625
            </test>
        </switch>

        <switch name="propulsion/engine/cutoff-high-pressure">
            <default value="1"/>
            <test logic="AND" value="0">
                fcs/throttle-pos-deg ge 8
                systems/flight/oil/pressure-drop-norm lt 0.5625
                propulsion/engine/n2 gt 16 <!-- source: 11-16% -->
            </test>
        </switch>
        
        <switch name="propulsion/engine/cutoff-jsbsim">
            <default value="1"/>
            <test logic="AND" value="0">
                propulsion/engine/cutoff-low-pressure == 0
                propulsion/engine/cutoff-high-pressure == 0
            </test>
            <output>propulsion/cutoff_cmd</output>
        </switch>
    </channel>

    <channel execrate="2" name="blinkers">

        <fcs_function name="systems/flight/blink/two">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>4</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/two-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/four">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>8</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/four-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/five">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>10</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/five-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/ten">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>20</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/ten-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/third">
            <function>
                <integer>
                    <min>
                        <mod>
                            <product>
                                <property>sim-time-sec</property>
                                <value>1</value>
                            </product>
                            <value>3</value>
                        </mod>
                        <value>1.99999999</value>
                    </min>
                </integer>
            </function>
            <output>/ja37/blink/third-Hz/state</output>
        </fcs_function>
    
    </channel>

</system>
